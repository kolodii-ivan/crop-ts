!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Jcrop=e():t.Jcrop=e()}(this,(()=>(()=>{"use strict";var t={d:(e,s)=>{for(var i in s)t.o(s,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{default:()=>g});class s{constructor(){this.events=new Map}on(t,e){return this.events.has(t)||this.events.set(t,new Set),this.events.get(t).add(e),this}off(t,e){return this.events.has(t)?(e?this.events.get(t).delete(e):this.events.delete(t),this):this}emit(t,...e){return this.events.has(t)?(this.events.get(t).forEach((t=>{try{t(...e)}catch(t){console.error("Error in event handler:",t)}})),this):this}}class i{static createElement(t,e={},s){const i=document.createElement(t);return Object.entries(e).forEach((([t,e])=>{"class"===t?i.className=e:i.setAttribute(t,e)})),s&&(i.textContent=s),i}static addClass(t,e){t.classList.add(e)}static removeClass(t,e){t.classList.remove(e)}static toggleClass(t,e,s){t.classList.toggle(e,s)}static hasClass(t,e){return t.classList.contains(e)}static getPosition(t){const e=t.getBoundingClientRect(),s=(t.offsetParent||document.body).getBoundingClientRect();return{left:e.left-s.left,top:e.top-s.top}}static css(t,e,s){"string"==typeof e&&void 0!==s?t.style[e]=s:"object"==typeof e&&Object.entries(e).forEach((([e,s])=>{t.style[e]=s}))}static width(t){return t.offsetWidth}static height(t){return t.offsetHeight}static setDimensions(t,e,s){t.style.width=`${e}px`,t.style.height=`${s}px`}static on(t,e,s,i){"function"==typeof s?t.addEventListener(e,s):t.addEventListener(e,(t=>{if(!i)return;const e=t.target;if(!e)return;const n=e.closest(s);n&&i.call(n,t)}))}static off(t,e,s){t.removeEventListener(e,s)}static wrap(t,e){return t.parentNode&&t.parentNode.insertBefore(e,t),e.appendChild(t),e}static before(t,e){t.parentNode&&t.parentNode.insertBefore(e,t)}static append(t,e){t.appendChild(e)}static remove(t){t.parentNode&&t.parentNode.removeChild(t)}static getComputedStyle(t,e){return window.getComputedStyle(t).getPropertyValue(e)}}class n{constructor(t,e,s){this.xmod=0,this.ymod=0,this.offsetX=0,this.offsetY=0,this.selection=e,this.direction=s;const i=this.getEventPosition(t),n=e.get();this.startX=i.x,this.startY=i.y,this.ox=n.x,this.oy=n.y,this.onMove=this.createMoveHandler(),this.onEnd=this.createEndHandler(),document.addEventListener("mousemove",this.onMove),document.addEventListener("mouseup",this.onEnd),document.addEventListener("touchmove",this.onMove,{passive:!1}),document.addEventListener("touchend",this.onEnd)}getEventPosition(t){let e,s;if("touches"in t){if(!t.touches.length)return{x:this.startX,y:this.startY};e=t.touches[0].pageX,s=t.touches[0].pageY}else e=t.pageX,s=t.pageY;const i=this.selection.core.container.getBoundingClientRect(),n=window.pageXOffset||document.documentElement.scrollLeft,o=window.pageYOffset||document.documentElement.scrollTop;return{x:e-(i.left+n),y:s-(i.top+o)}}createMoveHandler(){return t=>{t.preventDefault();const e=this.getEventPosition(t),s=e.x-this.startX,i=e.y-this.startY;this.updateSelection(s,i)}}createEndHandler(){return t=>{this.selection.endDrag(),t.preventDefault()}}updateSelection(t,e){const s=this.selection,i=s.get(),n=this.direction,o=Object.assign({},i);switch(n){case"move":o.x=this.ox+t,o.y=this.oy+e,o.x2=o.x+i.w,o.y2=o.y+i.h;break;case"n":o.y=this.oy+e,o.h=i.h-e;break;case"s":o.h=i.h+e;break;case"e":o.w=i.w+t;break;case"w":o.x=this.ox+t,o.w=i.w-t;break;case"nw":o.x=this.ox+t,o.y=this.oy+e,o.w=i.w-t,o.h=i.h-e;break;case"ne":o.y=this.oy+e,o.w=i.w+t,o.h=i.h-e;break;case"sw":o.x=this.ox+t,o.w=i.w-t,o.h=i.h+e;break;case"se":o.w=i.w+t,o.h=i.h+e}o.x2=o.x+o.w,o.y2=o.y+o.h,s.element.dispatchEvent(new CustomEvent("cropstart",{detail:[s,s.core.unscale(o)]})),s.updateRaw(o,n)}}class o{constructor(t){this.selection=t,this.core=t.core}animate(t,e,s,i,n){if(!this.core.options.animation)return this.selection.updateRaw({x:t,y:e,x2:t+s,y2:e+i,w:s,h:i},"se"),void("function"==typeof n&&n());const o=this.selection.get(),r=this.core.options.animDuration||400,a=performance.now(),h=c=>{const l=c-a,u=Math.min(l/r,1),d=o.x+(t-o.x)*u,p=o.y+(e-o.y)*u,f=o.w+(s-o.w)*u,m=o.h+(i-o.h)*u;this.selection.updateRaw({x:d,y:p,x2:d+f,y2:p+m,w:f,h:m},"se"),u<1?requestAnimationFrame(h):"function"==typeof n&&n()};requestAnimationFrame(h)}}const r={minSize:[8,8],maxSize:[0,0],aspectRatio:0,edge:{n:0,s:0,e:0,w:0},bgColor:null,bgOpacity:null,last:null,state:null,active:!0,linked:!0,canDelete:!0,canDrag:!0,canResize:!0,canSelect:!0};class a extends s{constructor(){super(),this.filter=[],Object.assign(this,r)}init(t){this.core=t,this.startup(),this.linked=t.options.linked,this.attach(),this.setOptions(t.options),this.element.dispatchEvent(new CustomEvent("cropcreate",{detail:[this]}))}attach(){}startup(){const t=this.core.options;Object.assign(this,r),this.filter=this.core.getDefaultFilters(),this.element=i.createElement("div",{class:t.cssSelection||"jcrop-selection"}),this.element.dataset.selection="true",this.frame=i.createElement("button",{class:t.cssButton||"jcrop-box jcrop-drag",type:"button","data-ord":"move"}),this.element.appendChild(this.frame),this.core.container.appendChild(this.element),this.insertElements(),this.frame.addEventListener("focus",(()=>{this.core.setSelection(this),this.element.dispatchEvent(new CustomEvent("cropfocus",{detail:this})),i.addClass(this.element,"jcrop-focus")})),this.frame.addEventListener("blur",(()=>{i.removeClass(this.element,"jcrop-focus"),this.element.dispatchEvent(new CustomEvent("cropblur",{detail:this}))}))}setOptions(t){for(const e of a.propagateList)void 0!==t[e]&&(this[e]=t[e]);return this.refresh(),this}refresh(){this.allowResize(),this.allowDrag(),this.allowSelect(),this.callFilterFunction("refresh"),this.updateRaw(this.get(),"se")}callFilterFunction(t){for(let e=0;e<this.filter.length;e++)this.filter[e][t]&&this.filter[e][t](this);return this}addFilter(t){t.core=this.core,this.hasFilter(t)||(this.filter.push(t),this.sortFilters(),t.init&&t.init(),this.refresh())}hasFilter(t){return this.filter.includes(t)}sortFilters(){this.filter.sort(((t,e)=>t.priority-e.priority))}clearFilters(){for(const t of this.filter)t.destroy&&t.destroy();this.filter=[]}removeFilter(t){const e=[];for(const s of this.filter)s.tag&&s.tag===t||s===t?s.destroy&&s.destroy():e.push(s);this.filter=e}runFilters(t,e){let s=Object.assign({},t);for(const t of this.filter)s=t.filter(s,e,this);return s}endDrag(){this.state&&(document.removeEventListener("mousemove",this.state.onMove),document.removeEventListener("mouseup",this.state.onEnd),document.removeEventListener("touchmove",this.state.onMove),document.removeEventListener("touchend",this.state.onEnd),this.focus(),this.state=null)}startDrag(t,e){if(!e){e=t.target.dataset.ord||"move"}return this.focus(),"move"===e&&i.hasClass(this.element,this.core.options.cssNoDrag||"jcrop-nodrag")||(this.state=new n(t,this,e)),!1}allowSelect(t){return void 0===t&&(t=this.canSelect),this.frame.disabled=!t||!this.canSelect,this}allowDrag(t){void 0===t&&(t=this.canDrag);const e=this.core.options.cssNoDrag||"jcrop-nodrag";return t&&this.canDrag?i.removeClass(this.element,e):i.addClass(this.element,e),this}allowResize(t){void 0===t&&(t=this.canResize);const e=this.core.options.cssNoResize||"jcrop-noresize";return t&&this.canResize?i.removeClass(this.element,e):i.addClass(this.element,e),this}remove(){this.element.dispatchEvent(new CustomEvent("cropremove",{detail:this})),i.remove(this.element)}toBack(){this.active=!1,i.removeClass(this.element,"jcrop-current"),i.removeClass(this.element,"jcrop-focus")}toFront(){this.active=!0,i.addClass(this.element,"jcrop-current"),this.callFilterFunction("refresh"),this.refresh()}redraw(t){return this.moveTo(t.x,t.y),this.resize(t.w,t.h),this.last=Object.assign({},t),this}update(t){return this.updateRaw(this.core.scale(t),"se")}updateRaw(t,e){const s=this.runFilters(t,e);return this.redraw(s),this.element.dispatchEvent(new CustomEvent("cropmove",{detail:[this,this.core.unscale(s)]})),this}animateTo(t,e){const s=new o(this),i=this.core.scale({x:t[0],y:t[1],w:t[2],h:t[3],x2:t[0]+t[2],y2:t[1]+t[3]});s.animate(i.x,i.y,i.w,i.h,e)}center(t=!1){const e=this.get(),s=this.core,i=s.container.offsetWidth,n=s.container.offsetHeight,o=[(i-e.w)/2,(n-e.h)/2,e.w,e.h];return t?this.setSelect(o):this.animateTo(o),this}createElement(t,e){return i.createElement("div",{class:`${t} ord-${e}`,"data-ord":e})}moveTo(t,e){i.css(this.element,{top:`${e}px`,left:`${t}px`})}blur(){return this.frame.blur(),this}focus(){return this.core.setSelection(this),this.frame.focus(),this}resize(t,e){i.css(this.element,{width:`${t}px`,height:`${e}px`})}get(){const t=i.getPosition(this.element),e=i.width(this.element),s=i.height(this.element);return{x:t.left,y:t.top,x2:t.left+e,y2:t.top+s,w:e,h:s}}setSelect(t){if(4!==t.length)throw new Error("Coordinate array must have 4 values");const e={x:t[0],y:t[1],x2:t[0]+t[2],y2:t[1]+t[3],w:t[2],h:t[3]};return this.update(e),this}insertElements(){const t=this.core.options;if(t.dragbars)for(const e of t.dragbars)this.element.appendChild(this.createElement(t.cssDragBars||"jcrop-dragbar jcrop-drag",e));if(t.handles)for(const e of t.handles)this.element.appendChild(this.createElement(t.cssHandles||"jcrop-handle jcrop-drag",e));if(t.borders)for(const e of t.borders)this.element.appendChild(this.createElement(t.cssBorders||"jcrop-border",e))}}a.propagateList=["canDelete","canDrag","canResize","canSelect","minSize","maxSize","aspectRatio","edge"];class h{constructor(t){this.shades=[],this.active=!1,this.initialized=!1,this.core=t,this.init()}init(){this.createShades(),this.initialized=!0}createShades(){const t=this.core.options.cssShades||"jcrop-shades",e=[i.createElement("div",{class:`${t} ${t}-north`}),i.createElement("div",{class:`${t} ${t}-east`}),i.createElement("div",{class:`${t} ${t}-south`}),i.createElement("div",{class:`${t} ${t}-west`})];for(const t of e)this.core.container.appendChild(t);this.shades=e;const s=this.core.options.bgColor||"black",n=this.core.options.bgOpacity||.5;for(const t of this.shades)i.css(t,{position:"absolute",backgroundColor:s,opacity:n.toString(),zIndex:"5"})}updateShades(t){if(!this.active)return;const e=this.core.container.offsetWidth,s=this.core.container.offsetHeight;i.css(this.shades[0],{left:"0px",top:"0px",width:`${e}px`,height:`${t.y}px`}),i.css(this.shades[1],{left:`${t.x+t.w}px`,top:`${t.y}px`,width:e-(t.x+t.w)+"px",height:`${t.h}px`}),i.css(this.shades[2],{left:"0px",top:`${t.y+t.h}px`,width:`${e}px`,height:s-(t.y+t.h)+"px"}),i.css(this.shades[3],{left:"0px",top:`${t.y}px`,width:`${t.x}px`,height:`${t.h}px`})}showShades(){if(!this.active){for(const t of this.shades)i.css(t,{display:"block"});this.active=!0}}hideShades(){if(this.active){for(const t of this.shades)i.css(t,{display:"none"});this.active=!1}}enable(){this.showShades(),i.addClass(this.core.container,"jcrop-active")}disable(){this.hideShades(),i.removeClass(this.core.container,"jcrop-active")}update(t){this.updateShades(t)}}class c{static load(t,e){const s=new Image;s.onload=function(){const t=s.naturalWidth,i=s.naturalHeight;e(t,i)},s.src=t}static attach(t,e){t.complete?e(t.naturalWidth,t.naturalHeight):t.onload=function(){e(t.naturalWidth,t.naturalHeight)}}}class l{constructor(t){this.core=t,this.init()}init(){this.core.container.classList.add("jcrop-touch"),this.core.container.addEventListener("touchmove",(t=>{t.preventDefault()}),{passive:!1}),this.core.container.addEventListener("contextmenu",(t=>(t.preventDefault(),!1))),this.core.container.addEventListener("touchstart",this.onTouchStart.bind(this))}onTouchStart(t){if(0===this.core.ui.multi.length&&!t.target.classList.contains(this.core.options.cssDrag||"jcrop-drag")){if(1!==t.touches.length)return;const e=t.touches[0],s=this.core.container.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;this.core.newSelection();const o=100;this.core.ui.selection.update({x:Math.max(0,i-o/2),y:Math.max(0,n-o/2),x2:Math.min(s.width,i+o/2),y2:Math.min(s.height,n+o/2),w:Math.min(o,s.width),h:Math.min(o,s.height)})}}}const u={};function d(t,e){u[t]=e}const p={edge:{n:0,s:0,e:0,w:0},setSelect:null,linked:!0,linkCurrent:!0,canDelete:!0,canSelect:!0,canDrag:!0,canResize:!0,allowSelect:!0,multi:!1,multiMax:!1,multiCleanup:!0,animation:!0,animEasing:"ease",animDuration:400,fading:!0,fadeDuration:300,fadeEasing:"ease",bgColor:"black",bgOpacity:.5,applyFilters:["constrain","extent","backoff","ratio","shader","round"],borders:["e","w","s","n"],handles:["n","s","e","w","sw","ne","nw","se"],dragbars:["n","e","w","s"],xscale:1,yscale:1,boxWidth:null,boxHeight:null,cssNoDrag:"jcrop-nodrag",cssDrag:"jcrop-drag",cssContainer:"jcrop-active",cssShades:"jcrop-shades",cssSelection:"jcrop-selection",cssBorders:"jcrop-border",cssHandles:"jcrop-handle jcrop-drag",cssButton:"jcrop-box jcrop-drag",cssNoResize:"jcrop-noresize",cssDragBars:"jcrop-dragbar jcrop-drag"};class f extends s{constructor(t,e={}){if(super(),this.state=null,this.filter={},"string"==typeof t){const e=document.querySelector(t);if(!e)throw new Error(`Element not found: ${t}`);t=e}this.options=Object.assign(Object.assign({},p),e),this.container=t,i.addClass(this.container,this.options.cssContainer||"jcrop-active"),this.ui={multi:[],selection:null},this.init(),this.setOptions(e),this.applySizeConstraints(),this.emit("cropinit",this)}init(){this.ui.manager=new h(this),this.applyFilters(),"ontouchstart"in window&&new l(this),this.initEvents()}applySizeConstraints(){const t=this.options,e=t.imgsrc;if(e){const s=e.naturalWidth||e.width,i=e.naturalHeight||e.height,n=t.boxWidth||s,o=t.boxHeight||i;if(s>n||i>o){const t=f.getLargestBox(s/i,n,o);e.width=t[0],e.height=t[1],this.resizeContainer(t[0],t[1]),this.options.xscale=s/t[0],this.options.yscale=i/t[1]}}if(t.trueSize){const e=t.trueSize[0],s=t.trueSize[1],i=this.getContainerSize();this.options.xscale=e/i[0],this.options.yscale=s/i[1]}}initComponent(t,...e){}setOptions(t,e){return this.options=Object.assign(Object.assign({},this.options),t),this.options.setSelect&&(this.ui.multi.length||this.newSelection(),this.setSelect(this.options.setSelect),this.options.setSelect=null),this.emit("configupdate"),this}destroy(){if(this.options.imgsrc){const t=this.options.imgsrc;i.before(this.container,t),i.remove(this.container),t.style.display=""}else i.remove(this.container)}applyFilters(){if(this.options.applyFilters)for(const t of this.options.applyFilters){const e=u[t]||null;if(e){const s=new e;s.core=this,s.init&&s.init(),this.filter[t]=s}}}getDefaultFilters(){if(!this.options.applyFilters)return[];const t=[];for(const e of this.options.applyFilters)this.filter[e]&&t.push(this.filter[e]);return t.sort(((t,e)=>t.priority-e.priority))}setSelection(t){const e=this.ui.multi,s=[];for(let i=0;i<e.length;i++)e[i]!==t&&(s.push(e[i]),e[i].toBack());return s.unshift(t),this.ui.multi=s,this.ui.selection=t,t.toFront(),t}getSelection(){return this.ui.selection?this.ui.selection.get():{x:0,y:0,x2:0,y2:0,w:0,h:0}}newSelection(t){return t||(t=new a),t.init(this),this.setSelection(t),t}hasSelection(t){return this.ui.multi.includes(t)}removeSelection(t){const e=this.ui.multi,s=[];for(let i=0;i<e.length;i++)t!==e[i]?s.push(e[i]):e[i].remove();return this.ui.multi=s,s.length&&this.ui.selection===t?this.ui.selection=s[0]:s.length||(this.ui.selection=null),s}addFilter(t){for(let e=0;e<this.ui.multi.length;e++)this.ui.multi[e].addFilter(t);return this}removeFilter(t){for(let e=0;e<this.ui.multi.length;e++)this.ui.multi[e].removeFilter(t);return this}blur(){return this.ui.selection&&this.ui.selection.blur(),this}focus(){return this.ui.selection&&this.ui.selection.focus(),this}initEvents(){this.container.addEventListener("selectstart",(t=>t.preventDefault())),this.container.addEventListener("mousedown",this.startDrag.bind(this))}maxSelect(){const t=this.getContainerSize();this.setSelect([0,0,t[0],t[1]])}nudge(t,e){if(!this.ui.selection)return;const s=this.ui.selection,i=s.get();i.x+=t,i.x2+=t,i.y+=e,i.y2+=e,i.x<0?(i.x2=i.w,i.x=0):i.x2>this.getContainerSize()[0]&&(i.x2=this.getContainerSize()[0],i.x=i.x2-i.w),i.y<0?(i.y2=i.h,i.y=0):i.y2>this.getContainerSize()[1]&&(i.y2=this.getContainerSize()[1],i.y=i.y2-i.h),s.element.dispatchEvent(new CustomEvent("cropstart",{detail:[s,this.unscale(i)]})),s.updateRaw(i,"move"),s.element.dispatchEvent(new CustomEvent("cropend",{detail:[s,this.unscale(i)]}))}refresh(){for(let t=0;t<this.ui.multi.length;t++)this.ui.multi[t].refresh()}blurAll(){for(const t of this.ui.multi)t.toBack()}scale(t){const e=this.options.xscale||1,s=this.options.yscale||1;return{x:t.x/e,y:t.y/s,x2:t.x2/e,y2:t.y2/s,w:t.w/e,h:t.h/s}}unscale(t){const e=this.options.xscale||1,s=this.options.yscale||1;return{x:t.x*e,y:t.y*s,x2:t.x2*e,y2:t.y2*s,w:t.w*e,h:t.h*s}}requestDelete(){this.ui.multi.length>1&&this.ui.selection&&this.ui.selection.canDelete&&this.deleteSelection()}deleteSelection(){this.ui.selection&&(this.removeSelection(this.ui.selection),this.ui.multi.length&&this.ui.selection&&this.ui.selection.refresh())}animateTo(t){return this.ui.selection&&this.ui.selection.animateTo(t),this}setSelect(t){return this.ui.selection&&t&&this.ui.selection.update(f.wrapFromXywh(t)),this}startDrag(t){if(0!==t.button)return;const e=t.target;if(!e)return;if(!e.classList.contains(this.options.cssDrag||"jcrop-drag"))return;let s=null;const i=e.closest(`.${this.options.cssSelection||"jcrop-selection"}`);if(i&&(s=this.ui.multi.find((t=>t.element===i))||null),!s)return;const n=e.getAttribute("data-ord")||"move";this.container.dispatchEvent(new CustomEvent("cropstart",{detail:[s,this.unscale(s.get())]})),s.startDrag(t,n),t.preventDefault()}getContainerSize(){return[this.container.offsetWidth,this.container.offsetHeight]}resizeContainer(t,e){this.container.style.width=`${t}px`,this.container.style.height=`${e}px`,this.refresh()}setImage(t,e){const s=this.options.imgsrc;return!!s&&(c.load(t,((i,n)=>{this.resizeContainer(i,n),s.src=t,s.width=i,s.height=n,this.applySizeConstraints(),this.refresh(),this.container.dispatchEvent(new CustomEvent("cropimage",{detail:[this,s]})),"function"==typeof e&&e.call(this,i,n)})),!0)}update(t){this.ui.selection&&this.ui.selection.update(t)}static getLargestBox(t,e,s){let i=e,n=e/t;return n>s&&(n=s,i=s*t),[Math.round(i),Math.round(n)]}static wrapFromXywh(t){if(4!==t.length)throw new Error("Coordinate array must have 4 values");return{x:t[0],y:t[1],x2:t[0]+t[2],y2:t[1]+t[3],w:t[2],h:t[3]}}}d("constrain",class{constructor(){this.priority=10,this.tag="constrain"}init(){}filter(t,e){const s=this.core.container.offsetWidth,i=this.core.container.offsetHeight,n=Object.assign({},t);return n.x<0&&(n.x=0),n.y<0&&(n.y=0),n.x2>s&&(n.x2=s),n.y2>i&&(n.y2=i),n.w=n.x2-n.x,n.h=n.y2-n.y,n}});d("ratio",class{constructor(){this.priority=20,this.tag="ratio"}init(){}filter(t,e,s){if(!s.aspectRatio)return t;const i=Object.assign({},t),n=s.aspectRatio;let o=i.w,r=i.h;return"n"===e||"s"===e?o=r*n:"e"===e||"w"===e?r=o/n:o/r>n?o=r*n:r=o/n,"n"!==e&&"nw"!==e&&"ne"!==e||(i.y=i.y2-r),"w"!==e&&"nw"!==e&&"sw"!==e||(i.x=i.x2-o),i.w=o,i.h=r,i.x2=i.x+o,i.y2=i.y+r,i}});function m(t,e={}){return new f(t,e)}d("shader",class{constructor(){this.priority=100,this.tag="shader"}init(){}filter(t){return this.core.ui.manager&&this.core.ui.manager.update(t),t}refresh(t){t.active&&this.core.ui.manager&&(this.core.ui.manager.showShades(),this.core.ui.manager.update(t.get()))}}),m.attach=(t,e={})=>new f(t,e);const g=m;return e=e.default})()));
//# sourceMappingURL=jcrop.js.map